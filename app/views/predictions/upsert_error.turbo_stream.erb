<%# Replace form with error state - the form will show the error inline %>
<%= turbo_stream.replace dom_id(@match, :prediction) do %>
  <div class="border border-red-300 rounded-lg p-4 bg-red-50"
       data-controller="prediction-form"
       data-prediction-form-match-status-value="<%= @match.match_status %>">

    <!-- Error message -->
    <div class="mb-3 text-sm text-red-600">
      <strong>Error:</strong> <%= @prediction.errors.full_messages.join(", ") %>
    </div>

    <!-- Re-render the form -->
    <%= form_with url: upsert_predictions_path,
                  method: :post,
                  data: {
                    turbo_frame: "_self",
                    prediction_form_target: "form"
                  } do |f| %>

      <%= hidden_field_tag :betting_pool_id, @betting_pool.id %>
      <%= hidden_field_tag :match_id, @match.id %>

      <div class="flex items-center justify-center space-x-4">
        <% @match.match_participants.each_with_index do |mp, i| %>
          <%
            pr = @prediction.predicted_results.find { |r| r.match_participant_id == mp.id }
            existing_score = pr&.score
          %>

          <div class="flex-1 text-center">
            <div class="font-medium text-gray-900 mb-2 truncate">
              <%= mp.participant.name %>
            </div>
            <input type="number"
                   name="prediction[predicted_results_attributes][<%= i %>][score]"
                   value="<%= existing_score %>"
                   min="0"
                   max="9"
                   data-prediction-form-target="scoreInput"
                   data-action="input->prediction-form#onInput"
                   class="w-16 h-12 text-center text-2xl font-bold border-2 rounded-lg border-red-300 focus:border-indigo-500 focus:ring-indigo-500">
            <%= hidden_field_tag "prediction[predicted_results_attributes][#{i}][match_participant_id]", mp.id %>
            <% if pr&.id %>
              <%= hidden_field_tag "prediction[predicted_results_attributes][#{i}][id]", pr.id %>
            <% end %>
          </div>

          <% if i == 0 %>
            <span class="text-gray-400 font-medium text-lg">vs</span>
          <% end %>
        <% end %>
      </div>

      <div data-prediction-form-target="loading" class="hidden mt-3 text-center">
        <span class="inline-flex items-center text-sm text-gray-500">
          <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-indigo-600" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Saving...
        </span>
      </div>
    <% end %>
  </div>
<% end %>
