<%# Local variables: match, prediction, betting_pool, show_stage (optional) %>
<% show_stage ||= false %>
<% is_open = match.bets_open? %>
<% has_prediction = prediction.present? && prediction.persisted? %>

<%
  # Find the predicted winner (the one with score=1)
  predicted_winner_mp_id = nil
  if prediction && prediction.predicted_results.any?
    if prediction.predicted_results.loaded?
      winner_pr = prediction.predicted_results.find { |r| r.score == 1 }
    else
      winner_pr = prediction.predicted_results.find_by(score: 1)
    end
    predicted_winner_mp_id = winner_pr&.match_participant_id
  end
%>

<div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors duration-150"
     data-controller="prediction-form"
     data-prediction-form-match-status-value="<%= match.match_status %>"
     data-prediction-form-match-type-value="multi_nominee">

  <!-- Match info header -->
  <div class="flex items-center justify-between mb-3">
    <div class="flex items-center space-x-3">
      <div class="text-sm text-gray-500">
        <%= match.match_date.strftime("%b %d, %H:%M") %>
        <% if show_stage && match.stage %>
          <span class="text-gray-400">|</span>
          <span class="text-gray-600"><%= match.stage.name %></span>
        <% end %>
      </div>
    </div>

    <!-- Spinner -->
    <div id="<%= dom_id(match, :prediction_spinner) %>"
         data-prediction-form-target="loading"
         class="hidden">
      <span class="inline-flex items-center text-sm text-gray-500">
        <svg class="animate-spin h-4 w-4 text-indigo-600" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </span>
    </div>

    <!-- Status badge -->
    <div id="<%= dom_id(match, :prediction_status) %>"
         data-prediction-form-target="status">
      <% if !is_open %>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
          <%= match.match_status.humanize %>
        </span>
      <% elsif has_prediction %>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-600">
          Saved
        </span>
      <% else %>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-600">
          Not predicted
        </span>
      <% end %>
    </div>
  </div>

  <!-- Prediction form -->
  <%= form_with url: upsert_predictions_path,
                method: :post,
                data: {
                  turbo_frame: "_self",
                  prediction_form_target: "form"
                } do |f| %>

    <%= hidden_field_tag :betting_pool_id, betting_pool.id %>
    <%= hidden_field_tag :match_id, match.id %>

    <div class="space-y-2">
      <h3 class="text-base font-semibold text-gray-900"><%= match.display_name %></h3>
      <div class="text-sm text-gray-500 mb-2">Pick the winner:</div>

      <% match.match_participants.each_with_index do |mp, i| %>
        <%
          is_selected = predicted_winner_mp_id == mp.id
          # Find existing predicted result for this participant
          existing_pr = nil
          if prediction && prediction.predicted_results.loaded?
            existing_pr = prediction.predicted_results.find { |r| r.match_participant_id == mp.id }
          elsif prediction
            existing_pr = prediction.predicted_results.find_by(match_participant_id: mp.id)
          end
        %>

        <label class="flex items-center p-3 rounded-lg border-2 cursor-pointer transition-colors
                      <%= is_selected ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-gray-300' %>
                      <%= 'opacity-60 cursor-not-allowed' unless is_open %>">
          <input type="radio"
                 name="predicted_winner_mp_id"
                 value="<%= mp.id %>"
                 data-prediction-form-target="scoreInput"
                 data-action="change->prediction-form#onInput"
                 class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"
                 <%= 'checked' if is_selected %>
                 <%= 'disabled' unless is_open %>>
          <span class="ml-3 font-medium text-gray-900"><%= mp.participant.name %></span>

          <%# Hidden fields to track the predicted_result record %>
          <%= hidden_field_tag "prediction[predicted_results_attributes][#{i}][match_participant_id]", mp.id %>
          <% if existing_pr&.id %>
            <%= hidden_field_tag "prediction[predicted_results_attributes][#{i}][id]", existing_pr.id %>
          <% end %>
        </label>
      <% end %>
    </div>

  <% end %>
</div>
