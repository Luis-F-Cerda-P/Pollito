<%# Local variables: match, prediction, betting_pool, show_stage (optional) %>
<% show_stage ||= false %>
<% is_open = match.bets_open? %>
<% has_prediction = prediction.present? && prediction.persisted? %>

<div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors duration-150"
     data-controller="prediction-form"
     data-prediction-form-match-status-value="<%= match.match_status %>">

  <!-- Match info header -->
  <div class="flex items-center justify-between mb-3">
    <!-- Match date and/or phase -->
    <div class="flex w-1/4 items-center space-x-3">
      <div class="text-sm text-gray-500">
        <%= match.match_date.strftime("%b %d, %H:%M") %>
        <% if show_stage && match.stage %>
          <span class="text-gray-400">|</span>
          <span class="text-gray-600"><%= match.stage.name %></span>
        <% end %>
      </div>
    </div>

    <!-- Spinner container (fixed height to prevent layout shift) -->
    <div class="flex h-5 items-center justify-center">
      <div id="<%= dom_id(match, :prediction_spinner) %>"
           data-prediction-form-target="loading"
           class="hidden">
        <span class="inline-flex items-center text-sm text-gray-500">
          <svg class="animate-spin h-4 w-4 text-indigo-600" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </span>
      </div>
    </div>

    <!-- Status badge -->
    <div id="<%= dom_id(match, :prediction_status) %>"
         data-prediction-form-target="status"
         class="w-1/4 text-end">
      <% if !is_open %>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
          <%= match.match_status.humanize %>
        </span>
      <% elsif has_prediction %>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-600">
          Saved
        </span>
      <% else %>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-600">
          Not predicted
        </span>
      <% end %>
    </div>
  </div>

  <!-- Prediction form -->
  <%= form_with url: upsert_predictions_path,
                method: :post,
                data: {
                  turbo_frame: "_self",
                  prediction_form_target: "form"
                } do |f| %>

    <%= hidden_field_tag :betting_pool_id, betting_pool.id %>
    <%= hidden_field_tag :match_id, match.id %>

    <%
      # Pre-fetch participant data for both sides
      participants_data = 2.times.map do |i|
        mp = match.match_participants[i]
        next nil unless mp.present?

        existing_score = nil
        if prediction && prediction.predicted_results.loaded?
          pr = prediction.predicted_results.find { |r| r.match_participant_id == mp.id }
          existing_score = pr&.score
        elsif prediction
          pr = prediction.predicted_results.find_by(match_participant_id: mp.id)
          existing_score = pr&.score
        end

        { mp: mp, existing_score: existing_score }
      end
    %>

    <div class="flex items-center justify-between gap-0 sm:gap-2">
      <!-- Team 1: Flag & Name column -->
      <% if participants_data[0] %>
        <% mp = participants_data[0][:mp] %>
        <div class="flex flex-col items-center w-18 sm:w-1/4">
          <% if mp.participant.image.attached? %>
            <%= image_tag mp.participant.image, class: "h-8 sm:h-10 object-cover border border-gray-200" %>
          <% end %>
          <span class="font-medium text-gray-900 text-xs sm:text-sm text-center leading-tight max-w-full" title="<%= mp.participant.name %>"><%= mp.participant.name %></span>
        </div>
      <% else %>
        <div class="flex flex-col items-center w-18 sm:w-1/4 shrink-0">
          <div class="h-8 sm:h-10 w-12 sm:w-14 bg-gray-100 border border-gray-200"></div>
          <span class="font-medium text-gray-400 text-xs sm:text-sm">TBD</span>
        </div>
      <% end %>

      <!-- Scores section -->
      <div class="flex-1 flex justify-center items-center gap-2 sm:gap-3">
        <!-- Input 1 -->
        <% if participants_data[0] %>
          <% mp = participants_data[0][:mp] %>
          <% existing_score = participants_data[0][:existing_score] %>
          <input type="number"
                      name="prediction[predicted_results_attributes][0][score]"
                      value="<%= existing_score %>"
                      min="0"
                      max="9"
                      data-prediction-form-target="scoreInput"
                      data-action="input->prediction-form#onInput"
          class="[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none
          w-10 h-10 sm:w-14 sm:h-14 text-center text-xl sm:text-2xl font-bold border-2 rounded-lg
          <%= is_open ? 'border-gray-300 focus:border-indigo-500 focus:ring-indigo-500' : 'border-gray-200 bg-gray-100 text-gray-500 cursor-not-allowed' %>"
          <%= 'disabled' unless is_open %>>
          <%= hidden_field_tag "prediction[predicted_results_attributes][0][match_participant_id]", mp.id %>
          <% if prediction && !prediction.new_record? %>
            <% pr = prediction.predicted_results.find { |r| r.match_participant_id == mp.id } || prediction.predicted_results.find_by(match_participant_id: mp.id) %>
            <% if pr&.id %>
              <%= hidden_field_tag "prediction[predicted_results_attributes][0][id]", pr.id %>
            <% end %>
          <% end %>
        <% else %>
          <input type="number" value="" min="0" max="9"
                      class="w-10 h-10 sm:w-14 sm:h-14 text-center text-lg sm:text-xl font-bold border-2 rounded-lg border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed"
                      disabled>
        <% end %>

        <!-- VS -->
        <span class="text-gray-400 font-medium text-sm sm:text-lg shrink-0">vs</span>

        <!-- Input 2 -->
        <% if participants_data[1] %>
          <% mp = participants_data[1][:mp] %>
          <% existing_score = participants_data[1][:existing_score] %>
          <input type="number"
                      name="prediction[predicted_results_attributes][1][score]"
                      value="<%= existing_score %>"
                      min="0"
                      max="9"
                      data-prediction-form-target="scoreInput"
                      data-action="input->prediction-form#onInput"
          class="[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none
          w-10 h-10 sm:w-14 sm:h-14 text-center text-xl sm:text-2xl font-bold border-2 rounded-lg
          <%= is_open ? 'border-gray-300 focus:border-indigo-500 focus:ring-indigo-500' : 'border-gray-200 bg-gray-100 text-gray-500 cursor-not-allowed' %>"
          <%= 'disabled' unless is_open %>>
          <%= hidden_field_tag "prediction[predicted_results_attributes][1][match_participant_id]", mp.id %>
          <% if prediction && !prediction.new_record? %>
            <% pr = prediction.predicted_results.find { |r| r.match_participant_id == mp.id } || prediction.predicted_results.find_by(match_participant_id: mp.id) %>
            <% if pr&.id %>
              <%= hidden_field_tag "prediction[predicted_results_attributes][1][id]", pr.id %>
            <% end %>
          <% end %>
        <% else %>
          <input type="number" value="" min="0" max="9"
                      class="w-10 h-10 sm:w-14 sm:h-14 text-center text-lg sm:text-xl font-bold border-2 rounded-lg border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed"
                      disabled>
        <% end %>
      </div>

      <!-- Team 2: Flag & Name column -->
      <% if participants_data[1] %>
        <% mp = participants_data[1][:mp] %>
        <div class="flex flex-col items-center w-18 sm:w-1/4 shrink-0">
          <% if mp.participant.image.attached? %>
            <%= image_tag mp.participant.image, class: "h-8 sm:h-10 object-cover border border-gray-200" %>
          <% end %>
          <span class="font-medium text-gray-900 text-xs sm:text-sm text-center leading-tight max-w-full" title="<%= mp.participant.name %>"><%= mp.participant.name %></span>
        </div>
      <% else %>
        <div class="flex flex-col items-center w-18 sm:w-1/4 shrink-0">
          <div class="h-8 sm:h-10 w-12 sm:w-14 bg-gray-100 border border-gray-200"></div>
          <span class="font-medium text-gray-400 text-xs sm:text-sm">TBD</span>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
